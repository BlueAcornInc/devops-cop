#!/usr/bin/env node

var program = require('commander');
var cop = require('..');
var handy = require('handy');

var doc = "",
    stdIn = process.stdin,
    inputformat, outputformat;

/**
 * Setup Input and Output
 */

program
    .version('v' + cop.version)
    .option('-i, --input <input>', 'Input file')
    .option('-f, --from <format>', 'Input format')
    .option('-t, --to <format>', 'Output format')
    .option('-T, --template [template]', 'Template')
    .parse(process.argv)
    .on('--help', function(){
        console.log('  Examples:');
        console.log('');
        console.log('    $ cat examples/setting.xml | bin/cop --from xml --to json');
        console.log('    $ bin/cop --input examples/setting.xml --to json');
        console.log('    $ bin/cop --input examples/setting.json,examples/setting.yml --to json');
        console.log('    $ bin/cop --input examples/setting.json,examples/setting.yml --template examples/views/Dockerfile.hbs');
        console.log('');
    });

if (program.input) {
    inputformat = handy.getFileExtension(program.input, 'json');
    outputformat = handy.getFileExtension(program.output, 'json');

    if (!process.argv.slice(2).length) {
        showHelp();
    }

    // output to stdout
    output(true, program.input, program.to);

} else {
    outputformat = program.to;
    inputformat = program.from;

    if (!process.argv.slice(2).length) {
        showHelp();
    }

    stdIn.on('data', (chunk) => {
        doc += chunk.toString();
    });

    stdIn.on('end', () => {
        // output to stdout
        output(false, doc, outputformat, inputformat);
    });

    stdIn.on('readable', () => {
        if(doc.length === 0){
            showHelp();
        }
    });

    stdIn.on('error', process.exit);
}

function output (fileToLoad, input, outputformat, inputformat) {

    // convert yml to yaml
    outputformat = (!outputformat || outputformat == 'yml') ? 'yaml' : outputformat;

    // load appropriate format
    if(fileToLoad) {
        // gather all input streams
        doc = cop.gatherInputs(input);
    } else {
        doc = cop.gatherInputs(input, inputformat);
    }

    if(!program.template) {
        console.log(cop.format[outputformat].stringify(doc));
    } else {
        console.log(cop.render(program.template, doc));
    }

}

function showHelp() {
    program.outputHelp();
    process.exit(1);
}